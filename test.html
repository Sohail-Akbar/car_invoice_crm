<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Select Box with Conditional Add Button</title>
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Select2 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <!-- Select2 JS -->
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <!-- Bootstrap CSS for modal -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap JS for modal -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <style>
        .select2-container .select2-results__option.add-new {
            color: blue;
            font-weight: bold;
        }
    </style>
</head>

<body>

    <div class="container mt-5">
        <!-- Example select box -->
        <select id="mySelect" data-popup="#addModal" data-add="true" style="width: 100%">
            <!-- <option value="Apple">Apple</option>
            <option value="Banana">Banana</option>
            <option value="Orange">Orange</option> -->
        </select>
    </div>

    <!-- Modal -->
    <div class="modal fade" id="addModal" tabindex="-1" aria-labelledby="addModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addModalLabel">Add New Item</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="text" id="newItem" class="form-control" placeholder="Enter new item">
                </div>
                <div class="modal-footer">
                    <button type="button" id="saveItem" class="btn btn-primary">Save</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        $(document).ready(function () {
            $('select').each(function () {
                var $select = $(this);
                var enableAdd = $select.data('add') === true || $select.data('add') === "true";
                var popupSelector = $select.data('popup');

                if (enableAdd && popupSelector) {
                    $select.select2({
                        placeholder: "Select or search item",
                        allowClear: true,
                        tags: true,
                        createTag: function (params) {
                            return {
                                id: params.term,
                                text: '+ Add',
                                newOption: true
                            };
                        },
                        templateResult: function (data) {
                            if (data.newOption) {
                                return $('<span class="add-new">' + data.text + '</span>');
                            }
                            return data.text;
                        },
                        language: {
                            noResults: function () {
                                // Return HTML for the +Add button
                                return $('<button class="btn btn-link add-new-no-result">+ Add</button>');
                            }
                        },
                        escapeMarkup: function (markup) {
                            return markup; // Allow HTML in noResults
                        }
                    }).on('select2:select', function (e) {
                        if (e.params.data.newOption) {
                            $select.val(null).trigger('change');
                            $(popupSelector).modal('show');
                            $(popupSelector).find('#newItem').val(e.params.data.id);

                            $(popupSelector).find('#saveItem').off('click').on('click', function () {
                                var newItem = $(popupSelector).find('#newItem').val();
                                if (newItem) {
                                    var newOption = new Option(newItem, newItem, true, true);
                                    $select.append(newOption).trigger('change');
                                    $(popupSelector).modal('hide');
                                }
                            });
                        }
                    });

                    // Handle click on the noResults +Add button
                    $(document).on('click', '.add-new-no-result', function () {

                        $(popupSelector).modal('show');
                        $(popupSelector).find('#newItem').val('');
                    });

                } else {
                    // Normal Select2 behavior
                    $select.select2({
                        placeholder: "Select or search item",
                        allowClear: true
                    });
                }
            });
        });
    </script>



</body>

</html>